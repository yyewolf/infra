apiVersion: v1
kind: ConfigMap
metadata:
  name: mosquitto-config
data:
  mosquitto.conf: |
    listener 1883
    allow_anonymous false
    password_file /mosquitto/config/passwords
    persistence true
    persistence_location /mosquitto/data/
    log_dest stdout
    log_type all

  acl_file: |
    # Home Assistant can publish/subscribe to all
    user homeassistant
    topic readwrite #

    # Frigate publishes events and subscribes to its own topics
    user frigate
    topic readwrite frigate/#

    # zigbee2mqtt can publish/subscribe to all
    user zigbee2mqtt
    topic readwrite zigbee2mqtt/#
    topic readwrite homeassistant/device_automation/#
    topic readwrite homeassistant/sensor/#
    topic readwrite homeassistant/light/#
    topic readwrite homeassistant/switch/#
    topic readwrite homeassistant/cover/#
    topic readwrite homeassistant/binary_sensor/#
    topic readwrite homeassistant/button/#
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mqtt
spec:
  serviceName: "mqtt"
  replicas: 1
  selector:
    matchLabels:
      app: mqtt
  template:
    metadata:
      labels:
        app: mqtt
    spec:
      tolerations:
        - key: PrivateNode
          operator: Equal
          value: home1
      containers:
        - name: mosquitto
          image: eclipse-mosquitto:2.0@sha256:6852da90a65dfff7aa3a1c8b249e92bb83c17ea8bbcce56bedff8707332a1a29
          ports:
            - containerPort: 1883
          volumeMounts:
            - name: config
              mountPath: /mosquitto/config/mosquitto.conf
              subPath: mosquitto.conf
            - name: acl
              mountPath: /mosquitto/config/aclfile
              subPath: acl_file
            - name: passwords
              mountPath: /mosquitto/config/passwords
              subPath: passwords
      volumes:
        - name: config
          configMap:
            name: mosquitto-config
            items:
              - key: mosquitto.conf
                path: mosquitto.conf
        - name: acl
          configMap:
            name: mosquitto-config
            items:
              - key: acl_file
                path: acl_file
        - name: passwords
          secret:
            secretName: mosquitto-passwords
---
apiVersion: v1
kind: Service
metadata:
  name: mosquitto
spec:
  type: NodePort
  selector:
    app: mqtt
  ports:
    - port: 1883
      targetPort: 1883
      nodePort: 31883
