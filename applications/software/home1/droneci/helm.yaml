---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: drone
  namespace: droneci
spec:
  interval: 1h
  url: https://charts.drone.io
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: drone
  namespace: droneci
spec:
  interval: 5m
  chart:
    spec:
      chart: drone
      version: 0.6.5 
      sourceRef:
        kind: HelmRepository
        name: drone
        namespace: droneci
  values:
    image:
      registry: mirror.gcr.io
    persistentVolume:
      enabled: false
    resources: 
      limits:
        cpu: 100m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 128Mi
  valuesFrom:
    - kind: Secret
      name: droneci-secret
      valuesKey: serverEnv
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: drone-runner
  namespace: droneci
spec:
  interval: 5m
  chart:
    spec:
      chart: drone-runner-docker
      version: 0.7.0
      sourceRef:
        kind: HelmRepository
        name: drone
        namespace: droneci
  values:
    autoscaling:
      enabled: true
      maxReplicas: 3
      minReplicas: 1
      targetCPUUtilizationPercentage: 80
    dind:
      registry: mirror.gcr.io
      repository: maniator/dind-buildx
      tag: docker_28.4.0-buildx_0.28.0
    gc:
      registry: mirror.gcr.io
    image:
      registry: mirror.gcr.io
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
    tolerations:
    - key: PrivateNode
      operator: Equal
      value: home1
  valuesFrom:
    - kind: Secret
      name: droneci-secret
      valuesKey: runnerEnv